# PhotoCleaner 기능 명세서

## 앱 개요

| 항목 | 내용 |
|-----|------|
| **목적** | 사진첩의 문제 있는 사진을 감지하고 정리하는 iOS 앱 |
| **타겟 iOS** | iOS 26+ |
| **UI 구성** | 대시보드형 메인 화면 |

---

## 화면 구조

```
┌─────────────────────────────────────────┐
│            PhotoCleaner                 │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │      📊 전체 요약 카드           │   │
│  │  "12,345장 중 47장에 문제 발견"  │   │
│  │  [전체 검사하기]                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ── 문제 유형 ──────────────────────   │
│                                         │
│  ┌──────────┐  ┌──────────┐            │
│  │ ☁️ 12장  │  │ ⚠️ 3장   │            │
│  │ 다운로드 │  │ 손상됨   │            │
│  │ 실패     │  │          │            │
│  └──────────┘  └──────────┘            │
│                                         │
│  ┌──────────┐  ┌──────────┐            │
│  │ 📱 28장  │  │ 📦 4장   │            │
│  │ 스크린샷 │  │ 대용량   │            │
│  │          │  │          │            │
│  └──────────┘  └──────────┘            │
│                                         │
│  ── 중복 사진 ─────────────────────    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🔄 중복 그룹 5개 (15장)         │   │
│  │ 정리하면 약 45MB 확보 가능       │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 기능 상세

### 1. 대시보드 (메인 화면)

#### 1.1 전체 요약 카드
- 총 사진/동영상 개수
- 문제 발견된 항목 수
- 마지막 검사 시간
- **[전체 검사하기]** 버튼 → 모든 문제 유형 스캔

#### 1.2 문제 유형별 카드
각 카드는 탭하면 해당 유형의 상세 목록으로 이동

| 카드 | 아이콘 | 설명 |
|-----|-------|------|
| 다운로드 실패 | `exclamationmark.icloud` | iCloud에서 가져올 수 없는 사진 |
| 손상됨 | `exclamationmark.triangle` | 열 수 없거나 깨진 사진 |
| 스크린샷 | `rectangle.on.rectangle` | 스크린샷만 모아서 표시 |
| 대용량 | `externaldrive` | 설정 크기 이상의 파일 |

#### 1.3 중복 사진 카드
- 중복 그룹 개수
- 총 중복 사진 수
- 정리 시 예상 확보 용량

---

### 2. 사진 권한 요청

#### 2.1 권한 플로우

```
앱 최초 실행
    │
    ▼
┌─────────────────────────────────┐
│  📸 사진 접근 권한이 필요해요    │
│                                 │
│  PhotoCleaner가 사진첩의 문제를  │
│  찾고 정리하려면 사진 접근       │
│  권한이 필요합니다.             │
│                                 │
│  • 사진은 기기에서만 분석됩니다  │
│  • 외부로 전송되지 않습니다     │
│                                 │
│  [권한 허용하기]                │
└─────────────────────────────────┘
    │
    ▼
시스템 권한 다이얼로그
    │
    ├─ "모든 사진 접근 허용" → 전체 기능 사용 가능
    │
    ├─ "제한된 사진만 선택" → 선택된 사진만 분석
    │
    └─ "허용 안 함" → 권한 필요 안내 화면
```

#### 2.2 권한 상태별 대응

| 상태 | 대응 |
|-----|------|
| `authorized` | 전체 기능 사용 |
| `limited` | 선택된 사진만 분석, 추가 선택 유도 |
| `denied` | 설정 앱으로 이동 안내 |
| `restricted` | 기기 제한 안내 |
| `notDetermined` | 권한 요청 화면 표시 |

---

### 3. iCloud 다운로드 실패 감지

#### 3.1 감지 기준
```swift
// PHAsset의 리소스 상태 확인
PHAssetResource.assetResources(for: asset)
    .contains { $0.type == .photo && !$0.isAvailable }
```

#### 3.2 UI 표시
- 썸네일에 ☁️❌ 오버레이
- 문제 원인 표시: "iCloud에서 다운로드할 수 없음"
- 가능한 액션:
  - **[다시 시도]** - 다운로드 재시도
  - **[삭제]** - 사진 삭제 (복구 불가 경고)

#### 3.3 일괄 처리
- 전체 선택/해제
- 선택 항목 일괄 삭제
- 삭제 전 확인 다이얼로그

---

### 4. 손상된 사진 감지

#### 4.1 감지 방법
1. **메타데이터 검증**: 유효하지 않은 EXIF 데이터
2. **이미지 디코딩 테스트**: `CGImageSource`로 디코딩 시도
3. **파일 무결성**: 파일 크기 0 또는 비정상

#### 4.2 손상 유형
| 유형 | 설명 | 복구 가능성 |
|-----|------|------------|
| 완전 손상 | 파일 열 수 없음 | ❌ 불가능 |
| 부분 손상 | 일부만 표시됨 | ⚠️ 제한적 |
| 메타데이터 손상 | 이미지는 정상, 정보 손상 | ✅ 가능 |

#### 4.3 UI
- 손상 유형별 아이콘
- 복구 가능 여부 표시
- **[삭제]** 또는 **[복구 시도]** 액션

---

### 5. 스크린샷 정리

#### 5.1 감지 기준
```swift
asset.mediaSubtypes.contains(.screenshot)
```

#### 5.2 기능
- 날짜별 그룹핑
- 앱별 분류 (가능한 경우)
- 일괄 선택 및 삭제
- **[오래된 것만 선택]** - N일 이전 스크린샷 자동 선택

#### 5.3 스마트 필터
| 필터 | 설명 |
|-----|------|
| 오늘 | 오늘 찍은 스크린샷 |
| 이번 주 | 최근 7일 |
| 이번 달 | 최근 30일 |
| 오래된 것 | 30일 이상 된 것 |

---

### 6. 대용량 파일 감지

#### 6.1 설정 가능한 기준
- 기본값: 10MB 이상
- 사용자 설정: 5MB / 10MB / 25MB / 50MB / 100MB

#### 6.2 표시 정보
- 파일 크기
- 촬영 해상도
- 파일 형식 (HEIC, RAW, ProRAW 등)

#### 6.3 정렬 옵션
- 크기순 (큰 것 먼저)
- 날짜순
- 형식별

---

### 7. 중복 사진 감지

#### 7.1 감지 모드 (설정에서 선택)

| 모드 | 방식 | 정확도 | 속도 |
|-----|------|-------|------|
| **완전 동일** | 이미지 해시 비교 | 100% | 빠름 |
| **유사 사진 포함** | 지각 해시(pHash) + Vision | 90%+ | 느림 |

#### 7.2 완전 동일 감지
```swift
// MD5 또는 SHA256 해시 비교
func imageHash(for asset: PHAsset) async -> String {
    // 원본 이미지 데이터의 해시 계산
}
```

#### 7.3 유사 사진 감지
```swift
// Vision 프레임워크 활용
let request = VNGenerateImageFeaturePrintRequest()
// 특징 벡터 추출 후 유사도 계산
```

#### 7.4 중복 그룹 UI
```
┌─────────────────────────────────────────┐
│ 중복 그룹 #1                            │
│ 3장 · 원본 제외 시 8.5MB 절약 가능       │
├─────────────────────────────────────────┤
│ ┌─────┐ ┌─────┐ ┌─────┐                │
│ │ 📷  │ │ 📷  │ │ 📷  │                │
│ │ ⭐  │ │     │ │     │                │
│ │원본 │ │중복1│ │중복2│                │
│ └─────┘ └─────┘ └─────┘                │
│                                         │
│ [원본만 남기고 삭제]    [직접 선택]      │
└─────────────────────────────────────────┘
```

#### 7.5 원본 선택 기준 (자동)
우선순위:
1. 해상도가 가장 높은 것
2. 파일 크기가 가장 큰 것
3. 가장 오래된 것 (원본일 가능성)

---

### 8. 설정

#### 8.1 검사 설정
| 항목 | 옵션 |
|-----|------|
| 대용량 기준 | 5MB / 10MB / 25MB / 50MB / 100MB |
| 중복 감지 모드 | 완전 동일만 / 유사 포함 |
| 유사도 기준 | 80% / 90% / 95% |
| 자동 검사 | 켜기 / 끄기 |

#### 8.2 표시 설정
| 항목 | 옵션 |
|-----|------|
| 썸네일 크기 | 작게 / 보통 / 크게 |
| 정렬 기준 | 날짜 / 크기 / 이름 |

#### 8.3 데이터
- **[검사 기록 초기화]** - 캐시된 분석 결과 삭제
- **[모든 설정 초기화]** - 앱 설정 기본값으로

---

## 데이터 모델

### PhotoIssue (문제 사진)
```swift
struct PhotoIssue: Identifiable {
    let id: String
    let asset: PHAsset
    let issueType: IssueType
    let severity: Severity
    let detectedAt: Date
    let metadata: IssueMetadata
}

enum IssueType: CaseIterable {
    case downloadFailed    // iCloud 다운로드 실패
    case corrupted         // 손상됨
    case screenshot        // 스크린샷
    case largeFile         // 대용량
    case duplicate         // 중복
}

enum Severity {
    case critical   // 즉시 조치 필요
    case warning    // 주의 필요
    case info       // 정보성
}
```

### DuplicateGroup (중복 그룹)
```swift
struct DuplicateGroup: Identifiable {
    let id: String
    let assets: [PHAsset]
    let suggestedOriginal: PHAsset
    let potentialSavings: Int64  // bytes
    let similarity: Double       // 0.0 ~ 1.0
}
```

---

## 화면 네비게이션

```
대시보드 (메인)
    │
    ├─→ 다운로드 실패 목록
    │       └─→ 사진 상세
    │
    ├─→ 손상된 사진 목록
    │       └─→ 사진 상세
    │
    ├─→ 스크린샷 목록
    │       └─→ 사진 상세
    │
    ├─→ 대용량 파일 목록
    │       └─→ 사진 상세
    │
    ├─→ 중복 그룹 목록
    │       └─→ 그룹 상세
    │               └─→ 사진 상세
    │
    └─→ 설정
            ├─→ 검사 설정
            ├─→ 표시 설정
            └─→ 데이터 관리
```

---

## 구현 우선순위

### Phase 1: MVP (핵심 기능) ✅ 완료
1. ✅ 사진 권한 요청
2. ✅ 대시보드 UI
3. ✅ iCloud 다운로드 실패 감지
4. ✅ 스크린샷 감지

### Phase 2: 확장 ✅ 완료
5. ✅ 손상된 사진 감지
6. ✅ 대용량 파일 감지
7. ✅ 중복 사진 감지 (완전 동일 - SHA256 해시)

### Phase 3: 고급 ✅ 완료
8. ✅ 유사 사진 감지 (Vision FeaturePrint)
9. ✅ 설정 화면
10. ✅ 자동 검사 기능 (Auto Scan)
11. ✅ 정렬 순서 설정 (Sort Order)

### Phase 4: 최적화 (진행 중)
12. ✅ 메타데이터 사전 필터링 (이미지 크기 기반)
13. ✅ 병렬 해싱 (TaskGroup, 최대 4 동시 실행)
14. ✅ Vision 처리 병렬화
15. 🔄 Partial Hashing 실험 중

---

## 기술 스택

| 영역 | 기술 |
|-----|------|
| UI | SwiftUI |
| 사진 접근 | PhotoKit (Photos framework) |
| 이미지 분석 | Vision, Core Image |
| 동시성 | Swift Concurrency (async/await) |
| 데이터 | SwiftData 또는 UserDefaults |
| 해시 | CryptoKit |
